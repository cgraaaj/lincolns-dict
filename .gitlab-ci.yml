image: docker:stable

stages:
  # - test
   - build
# test:
#   stage: test
#   before_script:
#     - docker build -t raju6713/docker-learn-react -f Dockerfile.dev .
#   script:
#     - echo "Testing App"
#     - docker run -e CI=true raju6713/docker-learn-react npm run test
#     - echo "Test successfully!"
#   tags: 
#     - ci

build:
  stage: build
  only:
    - master
  script:
    - apk add --no-cache docker-compose
    - echo "REACT_APP_DICTIONARY_API=$REACT_APP_DICTIONARY_API" > $(pwd)/.env 
    - echo "REACT_APP_WORDTRACKER_API=$REACT_APP_WORDTRACKER_API" >>  $(pwd)/.env 
    - docker-compose build lincolns_dictionary
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
    - docker push raju6713/lincolns_dictionary:latest
    - echo cleaning images
    - docker system prune -f
  tags:
    - ci
  
deploy:
  stage: deploy
  script:
    docker run --name=dictionary --env-file=.env -p 3006:80 raju6713/lincolns_dictionary 
  only:
    - master
  tags:
    - ci
